
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/jpg" href="https://iili.io/FvxcSaa.jpg"/>
  <title>Dokter AbidinAI</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7086399222908016"
     crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Semua CSS dari dashboard.html */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f7f7f8;
      color: #333;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .sidebar {
      width: 260px;
      background: #ffffff;
      border-right: 1px solid #e5e5e6;
      height: 100vh;
      position: fixed;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 100;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid #e5e5e6;
      margin-bottom: 20px;
    }

    .sidebar-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-title i {
      color: #4f46e5;
    }

    .sidebar-title span {
      font-weight: 700; 
      color: #5A4FF3;
      font-size: 22px;
    }

    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      padding: 0 10px;
    }

    .menu-badge {
      margin-left: auto;
      background: #4f46e5;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: #4a5568;
    }

    .menu-item:hover {
      background-color: #f3f4f6;
      color: #4f46e5;
    }

    .logout-item {
      background-color: #fef2f2;
      color: #ef4444;
      font-weight: 500;
      margin-top: 15px;
      border: 1px solid #fca5a5;
    }

    .logout-item:hover {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .menu-item.active {
      background-color: #eef2ff;
      color: #4f46e5;
      font-weight: 500;
    }

    .menu-item i {
      margin-right: 12px;
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e5e5e6;
      margin-top: auto;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4f46e5;
      font-weight: bold;
    }

    .user-name {
      font-weight: 500;
      font-size: 14px;
    }

    .user-role {
      font-size: 12px;
      color: #718096;
    }

    .main-content {
      flex: 1;
      margin-left: 260px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: margin 0.3s ease;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
    }

    .chat-header {
      padding: 20px 0;
      text-align: center;
      margin-bottom: 20px;
    }

    .chat-title {
      font-size: 28px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .chat-subtitle {
      color: #718096;
      font-size: 14px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
    }

    .message {
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      animation: fadeIn 0.3s ease;
    }

    .user-message {
      background-color: #ffffff;
      border: 1px solid #e5e5e6;
    }

    .ai-message {
      background-color: #f9fafb;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4f46e5;
      font-weight: bold;
      flex-shrink: 0;
    }

    .ai-avatar {
      background-color: #4f46e5;
      color: white;
    }

    .message-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-sender {
      font-weight: 600;
      margin-right: 8px;
    }

    .message-time {
      font-size: 12px;
      color: #718096;
    }

    .message-text {
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .code-container {
      margin: 15px 0;
      border-radius: 8px;
      overflow: hidden;
      background: #1e293b;
      border: 1px solid #374151;
    }

    .code-header {
      background-color: #374151;
      color: #f8fafc;
      padding: 10px 15px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-bottom: 1px solid #4a5568;
      font-size: 0.85rem;
    }

    .code-container .copy-btn {
      position: static;
      background: transparent;
      color: #f8fafc;
      border: 1px solid #6b7280;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .code-container .copy-btn:hover {
      background: #4f46e5;
      border-color: #4f46e5;
      color: white;
    }

    pre {
      background: #1e293b;
      color: #f8fafc;
      padding: 15px;
      border-radius: 0 0 8px 8px;
      overflow-x: auto;
      font-family: 'Fira Code', 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
      margin: 0;
    }

    #messageInput {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      min-height: 24px;
      max-height: 200px;
      line-height: 1.5;
      font-size: 16px;
      background: transparent;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-family: inherit;
    }

    #messageInput::placeholder {
      color: #9ca3af;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #718096;
      font-style: italic;
      padding: 12px 16px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(79, 70, 229, 0.3);
      border-radius: 50%;
      border-top-color: #4f46e5;
      animation: spin 1s ease-in-out infinite;
    }

    .input-container {
      padding: 20px 0;
      position: sticky;
      bottom: 0;
      background: #f7f7f8;
      border-top: 1px solid #e5e5e6;
    }

    .input-box {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      background: #ffffff;
      border: 1px solid #e5e5e6;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      flex-wrap: wrap;
      position: relative;
    }

    .input-buttons {
      display: flex;
      gap: 8px;
    }

    .plus-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background-color: #f3f4f6;
      color: #4b5563;
      transition: all 0.2s;
    }

    .plus-btn:hover {
      background-color: #e5e7eb;
    }

    .plus-menu {
      position: absolute;
      bottom: 60px;
      right: 120px;
      background: white;
      border: 1px solid #e5e5e6;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      padding: 8px;
      z-index: 10;
    }

    .plus-menu .menu-item {
      width: 100%;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
      transition: background-color 0.2s;
      border-radius: 6px;
      color: #4a5568;
    }

    .plus-menu .menu-item:hover {
      background-color: #f3f4f6;
      color: #4f46e5;
    }

    .ocr-btn, .voice-btn, .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .ocr-btn, .voice-btn {
      background-color: #f3f4f6;
      color: #4b5563;
    }

    .ocr-btn:hover, .voice-btn:hover {
      background-color: #e5e7eb;
    }

    .send-btn {
      background-color: #4f46e5;
      color: white;
    }

    .send-btn:hover {
      background-color: #4338ca;
    }

    .send-btn:disabled {
      background-color: #a5b4fc;
      cursor: not-allowed;
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 101;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 1px solid #e5e5e6;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .warning-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 0, 0, 0.9);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
    }

    .blur-screen {
      filter: blur(10px) !important;
    }

    .selectable {
      -webkit-touch-callout: text;
      -webkit-user-select: text;
      -khtml-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: flex;
      }
    }

    @media (max-width: 480px) {
      .chat-container {
        padding: 15px;
      }

      .message {
        flex-direction: column;
        gap: 8px;
      }

      .input-box {
        flex-direction: column;
        align-items: stretch;
      }

      .input-buttons {
        justify-content: flex-end;
      }
    }

    @media (max-width: 480px) {
      .input-buttons {
        order: 1;
      }

      .plus-menu {
        left: 0;
        right: auto;
        bottom: 100%;
        margin-bottom: 10px;
      }
    }

    .memory-controls {
      display: flex;
      justify-content: flex-end;
      padding: 10px 0;
      margin-bottom: 10px;
    }

    .memory-btn {
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .memory-btn:hover {
      background-color: #e5e7eb;
    }

    .memory-btn.clear {
      color: #ef4444;
    }

    .memory-btn.clear:hover {
      background-color: #fee2e2;
    }

    .message-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .action-btn {
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background-color: #e5e7eb;
    }

    .action-btn.copy {
      color: #4f46e5;
    }

    .action-btn.share {
      color: #10b981;
    }

    .action-btn.regenerate {
      color: #f59e0b;
    }

    .title-shortcut {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #2d3748;
    }

    .subtitle-shortcut {
      color: #718096;
      font-size: 14px;
      margin-bottom: 18px;
    }

    .shortcut-box {
        background: #fafafa;
        padding: 18px;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        width: 100%;
        max-width: 400px;
        margin: 0 auto 15px auto;
    }

    .btn-shortcut {
        background: #ffffff;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid #e6e6e6;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
    }

    .btn-shortcut:hover {
        background: #f3f4f6;
        border-color: #4f46e5;
    }

    .dropdown {
        display: none;
        margin: 0 auto 15px auto;
        background: #fafafa;
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 400px;
    }

    .dropdown.show {
        display: block;
    }

    .dropdown .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
        color: #4a5568;
    }

    .dropdown .item:hover {
        background: #f1f1f1;
        color: #4f46e5;
    }

    .logo-circle {
        width: 90px;
        height: 90px;
        background: linear-gradient(135deg, #4f46e5, #3b82f6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(79,70,229,0.3);
    }

    .logo-circle i {
      font-size: 40px;
      color: white;
    }

    /* Styling khusus untuk halaman dokter */
    .doctor-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .doctor-icon {
      font-size: 48px;
      color: #4f46e5;
      margin-bottom: 15px;
    }

    .doctor-title {
      font-size: 32px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .doctor-subtitle {
      color: #718096;
      font-size: 16px;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    if (!localStorage.getItem("abidinai_token")) {
      window.location.href = "../index.html";
    }
  </script>

</head>
<body class="selectable">
  <div class="warning-overlay" id="warningOverlay">
    <div style="text-align: center;">
      <i class="fas fa-shield-alt" style="font-size: 48px; margin-bottom: 20px; color: #ff0000;"></i>
      <h2>ðŸš« AKSES TERDETEKSI!</h2>
      <p>Developer Tools terdeteksi. Halaman akan diblokir!</p>
      <p>Silakan tutup Developer Tools untuk melanjutkan.</p>
    </div>
  </div>

  <div class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <i class="fas fa-robot"></i>
        <span>Balas AI</span>
      </div>
    </div>

    <div class="sidebar-menu">
      <a href="index.html" class="menu-item">
        <i class="fas fa-comment-dots"></i>
        <span>Obrolan AI</span>
      </a>

      <a href="creator.html" class="menu-item">
        <i class="fas fa-paint-brush"></i>
        <span>AbidinAI CREATOR</span>
      </a>
      
      <a href="translate.html" class="menu-item">
        <i class="fas fa-language"></i>
        <span>Terjemahan Otomatis</span>
      </a>
      
      <a href="https://lynk.id/abidincerdas" class="menu-item" target="_blank">
        <i class="fas fa-shopping-cart"></i>
        <span>Jualan Produk Digital</span>
      </a>

      <a href="alarm.html" class="menu-item">
        <i class="fas fa-bell"></i>
        <span>Alarm AI</span>
      </a>

      <a href="obrolan.html" class="menu-item">
        <i class="fas fa-comments"></i>
        <span>Obrolan AI</span>
      </a>

      <a href="obrolanfull.html" class="menu-item">
        <i class="fas fa-brain"></i>
        <span>Obrolan AI Full</span>
      </a>

      <a href="#" class="menu-item active">
        <i class="fas fa-user-md"></i>
        <span>Dokter Kesehatan</span>
      </a>

      <a href="https://wa.me/6283169364879" class="menu-item" target="_blank">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Lapor Masalah</span>
      </a>

      <div class="menu-item" id="musicMenuItem">
        <i class="fas fa-music"></i>
        <span>Putar Musik</span>
      </div>

      <a href="aplikasi.html" class="menu-item">
        <i class="fas fa-download"></i>
        <span>Install AbidinAI</span>
      </a>
      
      <div class="menu-item logout-item" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>Keluar</span>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">A</div>
        <div>
          <div class="user-name">Abidin</div>
          <div class="user-role">Developer</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content" id="mainContainer">
    <div class="chat-container">
      <div class="chat-header">
        <div class="doctor-header">
          <div class="logo-circle">
            <i class="fas fa-user-md"></i>
          </div>
          <h1 class="doctor-title">Dokter AbidinAI</h1>
          <p class="doctor-subtitle">
            Asisten kesehatan digital yang siap membantu Anda dengan informasi dan saran medis.
            Konsultasikan keluhan kesehatan Anda dengan aman dan terpercaya.
          </p>
        </div>
      </div>

      <div class="memory-controls">
        <button class="memory-btn clear" id="clearMemoryBtn">
          <i class="fas fa-trash"></i> Hapus Percakapan
        </button>
      </div>

      <div class="chat-messages" id="chatbox">
        <!-- Pesan akan ditampilkan di sini -->
      </div>

      <div class="input-container">
        <div class="input-box">
          <textarea 
            id="messageInput" 
            placeholder="Tanyakan masalah kesehatan Anda..." 
            rows="1" 
            onkeypress="handleKeyPress(event)"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;"
          ></textarea>
          <div class="input-buttons">
            <button class="voice-btn" onclick="startVoiceRecognition()">
              <i class="fas fa-microphone-alt"></i>
            </button>
            <button class="send-btn" onclick="sendMessage()" id="sendButton">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer" loop>
    <source src="https://d.top4top.io/m_33403we8x0.mp3" type="audio/mpeg">
  </audio>

  <script>
    (function() {
      'use strict';

      let isVoiceMode = false;
      let listeningElement = null;
      let isMusicPlaying = false;
      let db = null;

      const devToolsState = {open: false, orientation: null};
      const devToolsThreshold = 160;

      const messageInput = document.getElementById('messageInput');
      
      // Event listener untuk handle paste
      messageInput.addEventListener('paste', function(e) {
        e.preventDefault();
        
        let pastedText = (e.clipboardData || window.clipboardData).getData('text');
        
        pastedText = pastedText
          .replace(/\r\n/g, '\n')
          .replace(/\t/g, '    ')
          .trim();
        
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const textBefore = this.value.substring(0, start);
        const textAfter = this.value.substring(end, this.value.length);
        
        this.value = textBefore + pastedText + textAfter;
        this.selectionStart = this.selectionEnd = start + pastedText.length;
        
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        this.dispatchEvent(new Event('input'));
      });

      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
      });

      const isAndroid = /android/i.test(navigator.userAgent);

      if (!isAndroid) {
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        document.addEventListener('dragstart', e => e.preventDefault());
      }

      document.addEventListener('keydown', function(e) {
        if (
          e.key === 'F12' ||
          (e.ctrlKey && e.shiftKey && e.key === 'I') ||
          (e.ctrlKey && e.shiftKey && e.key === 'C') ||
          (e.ctrlKey && e.shiftKey && e.key ==='J') ||
          (e.ctrlKey && e.key === 'U') ||
          (e.ctrlKey && e.key === 'S') ||
          e.key === 'F5' ||
          (e.ctrlKey && e.key === 'r')
        ) {
          e.preventDefault();
          e.stopPropagation();
          showWarning();
          return false;
        }
      });

      const detectDevTools = () => {
        if (window.outerHeight - window.innerHeight > devToolsThreshold ||
            window.outerWidth - window.innerWidth > devToolsThreshold) {
          if (!devToolsState.open) {
            devToolsState.open = true;
            showWarning();
          }
        } else {
          if (devToolsState.open) {
            devToolsState.open = false;
            hideWarning();
          }
        }
      };

      setInterval(detectDevTools, 300);

      const clearConsole = () => {
        if (typeof console !== 'undefined') {
          console.clear();
          console.log('%cðŸš« STOP!', 'color: red; font-size: 50px; font-weight: bold;');
          console.log('%câš ï¸ PERINGATAN KEAMANAN!', 'color: red; font-size: 20px; font-weight: bold;');
          console.log('%cHalaman ini dilindungi sistem keamanan Balas AI. Akses tidak sah akan diblokir!', 'color: red; font-size: 14px;');
        }
      };

      setInterval(clearConsole, 1000);
      clearConsole();

      function showWarning() {
        const overlay = document.getElementById('warningOverlay');
        const container = document.getElementById('mainContainer');
        if (overlay && container) {
          overlay.style.display = 'flex';
          container.classList.add('blur-screen');
          document.body.style.overflow = 'hidden';
        }
      }

      function hideWarning() {
        const overlay = document.getElementById('warningOverlay');
        const container = document.getElementById('mainContainer');
        if (overlay && container) {
          overlay.style.display = 'none';
          container.classList.remove('blur-screen');
          document.body.style.overflow = 'auto';
        }
      }

      (() => {
        const debugTrap = () => {
          debugger;
        };
        setInterval(debugTrap, 100);
      })();

      window.addEventListener('blur', clearConsole);
      window.addEventListener('focus', clearConsole);
      window.addEventListener('resize', detectDevTools);

      document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('open');
      });

      // Fungsi untuk membersihkan HTML tags dari teks
      function cleanHTMLTags(text) {
        return text.replace(/<[^>]*>/g, '');
      }

      // Fungsi untuk membersihkan karakter khusus dan formatting
      function cleanTextForDisplay(text) {
        let cleaned = text;
        
        // Hapus HTML tags
        cleaned = cleanHTMLTags(cleaned);
        
        // Hapus markdown formatting
        cleaned = cleaned.replace(/\*\*/g, '');
        cleaned = cleaned.replace(/`/g, '');
        cleaned = cleaned.replace(/#/g, '');
        
        // Hapus code blocks
        cleaned = cleaned.replace(/```[\s\S]*?```/g, '');
        
        // Normalize spasi
        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        
        return cleaned;
      }

      function formatBoldText(text) {
        return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      }

      function initDatabase() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open('DokterAIChatDB', 1);

          request.onerror = () => {
            console.error('IndexedDB error:', request.error);
            reject(request.error);
          };

          request.onsuccess = () => {
            db = request.result;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            if (!db.objectStoreNames.contains('conversations')) {
              const store = db.createObjectStore('conversations', { keyPath: 'id', autoIncrement: true });
              store.createIndex('timestamp', 'timestamp', { unique: false });
            }
          };
        });
      }

      function saveMessageToDB(sender, text, timestamp) {
        if (!db) return;

        const transaction = db.transaction(['conversations'], 'readwrite');
        const store = transaction.objectStore('conversations');

        const message = {
          sender: sender,
          text: text,
          timestamp: timestamp || new Date().getTime()
        };

        store.add(message);
      }

      function loadMessagesFromDB() {
        return new Promise((resolve, reject) => {
          if (!db) {
            resolve([]);
            return;
          }

          const transaction = db.transaction(['conversations'], 'readonly');
          const store = transaction.objectStore('conversations');
          const index = store.index('timestamp');
          const request = index.getAll();

          request.onsuccess = () => {
            resolve(request.result);
          };

          request.onerror = () => {
            reject(request.error);
          };
        });
      }

      function clearConversationFromDB() {
        if (!db) return;

        const transaction = db.transaction(['conversations'], 'readwrite');
        const store = transaction.objectStore('conversations');
        store.clear();
      }

      document.addEventListener('DOMContentLoaded', async function() {
        if (devToolsState.open) {
          showWarning();
          return;
        }

        try {
          await initDatabase();

          const messages = await loadMessagesFromDB();
          const chatbox = document.getElementById("chatbox");

          // Tambahkan pesan selamat datang
          const welcomeMsg = addMessage(
            'Dokter AI',
            'Selamat datang! Saya adalah Dokter Abidin, asisten kesehatan digital yang dikembangkan oleh Abidin. Saya khusus membantu memberikan informasi dan saran mengenai masalah kesehatan. Silakan tanyakan keluhan kesehatan Anda atau konsultasi medis yang diperlukan.<br><br><i>Catatan: Saya tidak bisa menjawab pertanyaan di luar topik kesehatan.</i>',
            'ai-message',
            null,
            false
          );

          if (messages.length > 0) {
            messages.forEach(msg => {
              const messageClass = msg.sender === 'Anda' ? 'user-message' : 'ai-message';
              addMessage(msg.sender, msg.text, messageClass, msg.timestamp, false);
            });
          }

          chatbox.scrollTop = chatbox.scrollHeight;
        } catch (error) {
          console.error('Error initializing database:', error);
        }

        document.getElementById('musicMenuItem').addEventListener('click', toggleAudio);

        document.getElementById('clearMemoryBtn').addEventListener('click', async function() {
          if (confirm('Apakah Anda yakin ingin menghapus semua riwayat percakapan?')) {
            try {
              await clearConversationFromDB();
              const chatbox = document.getElementById("chatbox");
              chatbox.innerHTML = '';

              // Tambahkan kembali pesan selamat datang
              const welcomeMsg = addMessage(
                'Dokter AI',
                'Selamat datang! Saya adalah Dokter Abidin, asisten kesehatan digital yang dikembangkan oleh Abidin. Saya khusus membantu memberikan informasi dan saran mengenai masalah kesehatan. Silakan tanyakan keluhan kesehatan Anda atau konsultasi medis yang diperlukan.<br><br><i>Catatan: Saya tidak bisa menjawab pertanyaan di luar topik kesehatan.</i>',
                'ai-message',
                null,
                false
              );

              const confirmationMsg = addMessage('Sistem', 'Riwayat percakapan telah dihapus.', 'ai-message', null, false);

              setTimeout(() => {
                if (confirmationMsg && confirmationMsg.parentNode) {
                  confirmationMsg.parentNode.removeChild(confirmationMsg);
                }
              }, 3000);
            } catch (error) {
              console.error('Error clearing conversation:', error);
              addMessage('Sistem', 'Gagal menghapus riwayat percakapan.', 'ai-message', null, false);
            }
          }
        });
      });

      function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      window.logout = function() {
          localStorage.removeItem("abidinai_token");
          clearConversationFromDB();
          window.location.href = "../index.html";
      };

      window.handleKeyPress = function(event) {
        if (devToolsState.open) {
          showWarning();
          return false;
        }

        if (event.key === 'Enter') {
          if (event.shiftKey) {
            return true;
          }

          if (isAndroid) {
            const textarea = document.getElementById("messageInput");
            const cursorPosition = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPosition);
            const textAfter = textarea.value.substring(cursorPosition, textarea.value.length);

            textarea.value = textBefore + '\n' + textAfter;
            textarea.selectionStart = textarea.selectionEnd = cursorPosition + 1;

            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';

            event.preventDefault();
            event.stopPropagation();
            return false;
          } else {
            event.preventDefault();
            sendMessage();
          }
        }
      };

      function toggleAudio() {
        if (devToolsState.open) {
          showWarning();
          return false;
        }

        const player = document.getElementById("audioPlayer");
        const menuItem = document.getElementById("musicMenuItem");
        if (player.paused) {
          player.play();
          menuItem.innerHTML = '<i class="fas fa-music"></i><span>Jeda Musik</span>';
          isMusicPlaying = true;
        } else {
          player.pause();
          menuItem.innerHTML = '<i class="fas fa-music"></i><span>Putar Musik</span>';
          isMusicPlaying = false;
        }
      }

      window.startVoiceRecognition = function() {
        if (devToolsState.open) {
          showWarning();
          return false;
        }

        if (!('webkitSpeechRecognition' in window)) {
          addMessage('Sistem', 'Browser Anda tidak mendukung pengenalan suara. Silakan gunakan Chrome atau Edge.', 'ai-message');
          return;
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'id-ID';
        recognition.start();

        const chatbox = document.getElementById("chatbox");
        if (listeningElement) {
          listeningElement.remove();
        }

        listeningElement = document.createElement("div");
        listeningElement.className = "message ai-message";
        listeningElement.innerHTML = `
          <div class="avatar ai-avatar"><i class="fas fa-robot"></i></div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">Sistem</span>
              <span class="message-time">${getCurrentTime()}</span>
            </div>
            <div class="message-text">
              <div class="typing-indicator">
                <div class="loading"></div>
                Mendengarkan keluhan Anda...
              </div>
            </div>
          </div>
        `;
        chatbox.appendChild(listeningElement);
        chatbox.scrollTop = chatbox.scrollHeight;

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById("messageInput").value = transcript;
          isVoiceMode = true;
          sendMessage();
        };

        recognition.onerror = function(event) {
          if (listeningElement) {
            listeningElement.remove();
            listeningElement = null;
          }

          if (event.error !== 'no-speech') {
            addMessage('Sistem', `Error: ${event.error}`, 'ai-message');
          }
        };
      };

      function addMessage(sender, text, messageClass, timestamp = null, save = true) {
        const chatbox = document.getElementById("chatbox");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${messageClass}`;

        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        messageDiv.innerHTML = `
          <div class="avatar ${messageClass === 'ai-message' ? 'ai-avatar' : ''}">
            ${messageClass === 'ai-message' ? '<i class="fas fa-user-md"></i>' : sender.charAt(0)}
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">${sender}</span>
              <span class="message-time">${timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTime()}</span>
            </div>
            <div class="message-text" id="${messageId}-text">${text}</div>
            ${messageClass === 'ai-message' ? `
            <div class="message-actions">
              <button class="action-btn copy" onclick="copyMessageText('${messageId}')">
                <i class="fas fa-copy"></i> Salin
              </button>
              <button class="action-btn share" onclick="shareMessageText('${messageId}')">
                <i class="fas fa-share-alt"></i> Bagikan
              </button>
            </div>
            ` : ''}
          </div>
        `;

        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        if (save) {
          saveMessageToDB(sender, text, timestamp);
        }

        return messageDiv;
      }

      window.copyMessageText = function(messageId) {
        const messageTextElement = document.getElementById(`${messageId}-text`);
        if (messageTextElement) {
          // Bersihkan HTML tags sebelum menyalin
          const textToCopy = cleanTextForDisplay(messageTextElement.innerHTML);
          
          navigator.clipboard.writeText(textToCopy).then(() => {
            const copyButton = document.querySelector(`button[onclick="copyMessageText('${messageId}')"]`);
            if (copyButton) {
              const originalHtml = copyButton.innerHTML;
              copyButton.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
              setTimeout(() => {
                copyButton.innerHTML = originalHtml;
              }, 2000);
            }
          }).catch(err => {
            console.error('Gagal menyalin teks: ', err);
          });
        }
      };

      window.shareMessageText = function(messageId) {
        const messageTextElement = document.getElementById(`${messageId}-text`);
        if (messageTextElement) {
          // Bersihkan HTML tags sebelum membagikan
          const rawText = cleanTextForDisplay(messageTextElement.innerHTML);
          const shareText = `*ðŸ‘¨â€âš•ï¸ Konsultasi dengan Dokter AbidinAI:*\n\n${rawText}\n\n_Dibagikan dari aplikasi Dokter AbidinAI._`;

          if (navigator.share) {
            navigator.share({
              title: 'Konsultasi Dokter AbidinAI',
              text: shareText
            }).catch(error => {
              if (error.name !== 'AbortError') {
                console.error('Error sharing:', error);
                const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(shareText)}`;
                window.open(whatsappUrl, '_blank');
              }
            });
          } else {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
            window.open(whatsappUrl, '_blank');
          }

          const shareButton = document.querySelector(`button[onclick="shareMessageText('${messageId}')"]`);
          if (shareButton) {
            const originalHtml = shareButton.innerHTML;
            shareButton.innerHTML = '<i class="fas fa-check"></i> Berhasil!';
            setTimeout(() => {
              shareButton.innerHTML = originalHtml;
            }, 2000);
          }
        }
      };

      window.sendMessage = async function() {
        if (devToolsState.open) {
          showWarning();
          return false;
        }

        const input = document.getElementById("messageInput");
        const userText = input.value.trim();

        if (!userText) return;

        const chatbox = document.getElementById("chatbox");
        const sendButton = document.getElementById("sendButton");

        const userDiv = addMessage('Anda', userText, 'user-message');

        const typingDiv = document.createElement("div");
        typingDiv.className = "message ai-message";
        typingDiv.innerHTML = `
          <div class="avatar ai-avatar"><i class="fas fa-user-md"></i></div>
          <div class="message-content">
            <div class="typing-indicator">
              <div class="loading"></div>
              Dokter AI sedang menganalisis keluhan Anda...
            </div>
          </div>
        `;
        chatbox.appendChild(typingDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        sendButton.disabled = true;
        input.value = '';
        input.style.height = 'auto';

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
              message: `Anda adalah dokter AI yang hanya menjawab pertanyaan kesehatan. Jika pertanyaan tidak terkait kesehatan, jawab dengan sopan bahwa Anda hanya bisa membantu masalah kesehatan. Berikan jawaban yang informatif, jelas, dan mudah dipahami. Jangan gunakan formatting markdown khusus atau kode HTML. Gunakan bahasa Indonesia yang baik dan ramah. Pertanyaan: ${userText}` 
            })
          });

          if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
          }

          const data = await response.json();
          let aiReply = data.reply;

          typingDiv.remove();

          if (!aiReply || aiReply.trim() === "") {
            displayMaintenanceMessage();
          } else {
            // Bersihkan teks sebelum ditampilkan
            aiReply = cleanTextForDisplay(aiReply);
            displayAIResponse(aiReply);
          }
        } catch (error) {
          typingDiv.remove();
          displayMaintenanceMessage();
          console.error("Error:", error);
          sendButton.disabled = false;
        }
      };

      function displayMaintenanceMessage() {
        const chatbox = document.getElementById("chatbox");
        const sendButton = document.getElementById("sendButton");

        if (listeningElement) {
          listeningElement.remove();
          listeningElement = null;
        }

        const rawMessage = 'Maaf, server Dokter AI sedang dalam proses perbaikan dan pemeliharaan. Silakan coba lagi dalam beberapa saat. Terima kasih atas pengertiannya!';

        const maintenanceDiv = addMessage(
          'Dokter AI',
          rawMessage,
          'ai-message'
        );

        sendButton.disabled = false;

        if (isVoiceMode) {
          speakClean(rawMessage);
        }
        isVoiceMode = false;
      }

      function displayAIResponse(aiReply) {
        const chatbox = document.getElementById("chatbox");
        const sendButton = document.getElementById("sendButton");

        if (listeningElement) {
          listeningElement.remove();
          listeningElement = null;
        }

        const container = document.createElement("div");
        container.className = "message ai-message";
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Format teks dengan bold jika ada
        const formattedText = formatBoldText(aiReply);
        
        container.innerHTML = `
          <div class="avatar ai-avatar"><i class="fas fa-user-md"></i></div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">Dokter AI</span>
              <span class="message-time">${getCurrentTime()}</span>
            </div>
            <div class="message-text" id="${messageId}-text">${formattedText}</div>
            <div class="message-actions">
              <button class="action-btn copy" onclick="copyMessageText('${messageId}')">
                <i class="fas fa-copy"></i> Salin
              </button>
              <button class="action-btn share" onclick="shareMessageText('${messageId}')">
                <i class="fas fa-share-alt"></i> Bagikan
              </button>
            </div>
          </div>
        `;
        
        chatbox.appendChild(container);
        saveMessageToDB('Dokter AI', aiReply);
        chatbox.scrollTop = chatbox.scrollHeight;
        sendButton.disabled = false;

        if (isVoiceMode) {
          speakClean(aiReply);
        }
        isVoiceMode = false;
      }

      function cleanForSpeech(text) {
        // Hapus HTML tags
        text = text.replace(/<[^>]*>/g, '');
        // Hapus karakter khusus
        text = text.replace(/[{}[\]\/=;]/g, '');
        // Hapus formatting markdown
        text = text.replace(/\*\*/g, '');
        text = text.replace(/`/g, '');
        
        return text.trim();
      }

      function speakClean(text) {
        const cleanText = cleanForSpeech(text);
        if (cleanText.length === 0) return;
        
        readWithPauses(cleanText);
      }

      function readWithPauses(text) {
        if (!('speechSynthesis' in window)) {
          console.log("Text-to-speech tidak didukung di browser ini");
          return;
        }

        const sentences = text.split(/(?<=[.!?])\s+/);
        const synth = window.speechSynthesis;
        synth.cancel();

        function speakNext(index) {
          if (index >= sentences.length) return;

          const cleanSentence = sentences[index].trim();
          if (!cleanSentence) return speakNext(index + 1);

          const utter = new SpeechSynthesisUtterance(cleanSentence);
          utter.lang = 'id-ID';
          utter.rate = 1.0;
          utter.pitch = 1.0;
          utter.volume = 1.0;

          utter.onend = () => setTimeout(() => speakNext(index + 1), 300);
          synth.speak(utter);
        }

        speakNext(0);
      }
    })();
  </script>
</body>
</html>
